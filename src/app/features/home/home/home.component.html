<!-- Overlay: s√≥lo si quedan reintentos -->
@if (shouldShowOverlay()) {
  <div class="location-overlay-home">
    <div class="location-modal">
      <i class="bi-geo"></i>
      <h3>{{ overlayConfig().title }}</h3>
      <p>{{ overlayConfig().message }}</p>

      <button class="retry-btn" (click)="retryLocation()" [disabled]="isRetrying()">
        <i class="bi bi-arrow-clockwise" [class.spinning]="isRetrying()"></i>
        {{ isRetrying() ? 'Getting location...' : overlayConfig().buttonText }}
      </button>

      <small>We'll try internet-based location</small>
    </div>
  </div>
}

<!-- HOME: if/else √∫nico para evitar parpadeos al volver de /iss -->
@if (!isNoLocationOrLocked()) {
  <!-- HOME NORMAL (loading o success mientras queden intentos) -->
  <div class="simple-home">
    <!-- HEADER -->
    <div class="simple-header">
      <div class="location-badge">{{ locationBadge() }}</div>
      <div class="app-icon">üõ∞Ô∏è</div>
      <h1>ISS Tracker</h1>
      <p class="tagline">See the Space Station pass overhead</p>
    </div>

    <!-- EXPLICACI√ìN -->
    <div class="what-is-iss">
      <div class="iss-explanation">
        <div class="iss-visual">
          <div class="iss-icon">üõ∞Ô∏è</div>
          <div class="movement-line"></div>
        </div>
        <div class="explanation-text">
          <h2>What is the ISS?</h2>
          <p>It's a space station orbiting Earth. <strong>You can see it pass overhead like a bright star!</strong></p>
          <p>We'll tell you when, where to look, and which path it will take.</p>
        </div>
      </div>
    </div>

    <!-- SOLO si hay ubicaci√≥n v√°lida: distancia, pases, mapa, ajustes -->
    @if (hasValidLocation()) {

      <!-- DISTANCIA -->
      <div class="iss-distance-now">
        <div class="distance-card">
          <div class="distance-icon">üìç</div>
          <div class="distance-info">
            <h3>ISS right now</h3>
            <div class="distance-big">
              @if (currentDistance() !== null) { {{ currentDistance() }} km } @else { --- }
            </div>
            <p>{{ distanceDescription() }}</p>
            <button class="view-details-btn" (click)="showISSNow()">View details</button>
          </div>
        </div>
      </div>

      <!-- PASES -->
      <div class="next-passes-simple">
        <h2>üóìÔ∏è When you'll see it</h2>

        @if (usingCache() && visiblePasses().length > 0) {
          <div class="status-note" aria-live="polite">Showing last known passes (cached)</div>
        }

        @if (isEmpty()) {
          <div class="empty-state">
            <p>We couldn't calculate passes right now.</p>
            <button class="retry-btn" (click)="refreshData()">Retry</button>
          </div>
        }

        @for (pass of visiblePasses(); track pass.id; let i = $index) {
          <div class="pass-card-simple" [class.night-pass]="isNightTime(pass.time)" [class.day-pass]="!isNightTime(pass.time)"
               (click)="goToMapWithPass(pass)" [class.next-pass]="i === 0">

            @if (i === 0) { <div class="next-badge">NEXT</div> }

            <div class="pass-time-simple">
              <div class="day">{{ pass.time | date:'EEEE, MMM d' }}</div>
              <div class="time">{{ pass.time | date:'HH:mm' }}</div>
            </div>

            <div class="pass-description-simple">
              <div class="pass-route-visual">
                <span class="appear-point">üü¢ {{ pass.from }}</span>
                <div class="pass-arrow">‚Üí</div>
                <span class="disappear-point">üî¥ {{ pass.to }}</span>
              </div>

              <div class="pass-elevation-human">üèîÔ∏è {{ pass.altitude }}</div>

              @if (isNightTime(pass.time)) {
                <div class="pass-duration-simple">{{ pass.duration }} minutes visible</div>
              }

              <div class="brightness-simple">{{ pass.brightness }}</div>
            </div>

            <div class="see-on-map-hint">
              <i class="bi bi-map-fill"></i>
              <span>See on map</span>
              <i class="bi bi-arrow-right"></i>
            </div>
          </div>
        }
      </div>

      <!-- CTA MAPA -->
      <div class="map-cta">
        <button class="big-map-button" (click)="goToMap()">
          <i class="bi bi-map-fill"></i>
          <span>See full map</span>
          <small>Explore complete trajectory</small>
        </button>
      </div>

      <!-- SETTINGS -->
      <div class="simple-settings">
        <button class="setting-item" (click)="toggleNotifications()" [class.notifications-enabled]="notificationsEnabled()">
          <i [class]="notificationsEnabled() ? 'bi bi-bell-fill' : 'bi bi-bell'"></i>
          <span>{{ notificationsEnabled() ? "Alerts ON" : "Enable Alerts" }}</span>
          <small>
            {{ notificationsEnabled()
              ? "You'll be notified before each pass"
              : "Get notified before visible passes" }}
          </small>
        </button>
      </div>
    }
  </div>

} @else {
  <!-- HOME SIMPLIFICADA (sin ubicaci√≥n tras agotar reintentos) -->
  <div class="simple-home">
    <div class="simple-header">
      <div class="location-badge">üìç Location unavailable</div>
      <div class="app-icon">üõ∞Ô∏è</div>
      <h1>ISS Tracker</h1>
      <p class="tagline">We couldn't get your location right now.</p>
    </div>

    <!-- EXPLICACI√ìN (tambi√©n aqu√≠, antes del CTA) -->
    <div class="what-is-iss">
      <div class="iss-explanation">
        <div class="iss-visual">
          <div class="iss-icon">üõ∞Ô∏è</div>
          <div class="movement-line"></div>
        </div>
        <div class="explanation-text">
          <h2>What is the ISS?</h2>
          <p>It's a space station orbiting Earth. <strong>You can see it pass overhead like a bright star!</strong></p>
          <p>Open the live map to follow it right now.</p>
        </div>
      </div>
    </div>

    <div class="no-location-card">
      <div class="cta-row">
        <button class="view-details-btn" (click)="showISSNow()">View live ISS map</button>

        <button class="retry-btn"
                (click)="retryApproxFromHome()"
                [disabled]="isRetrying() || cooldownRemaining() > 0">
          @if (cooldownRemaining() > 0) {
            Try again in {{ cooldownRemaining() }}s
          } @else if (isRetrying()) {
            Getting location...
          } @else {
            Try approximate location
          }
        </button>
      </div>

      <small class="helper-note">
        We don't have your exact GPS (permissions denied or unavailable).
        Approximate location uses your internet connection.
      </small>
    </div>
  </div>
}